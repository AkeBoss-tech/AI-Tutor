<!DOCTYPE html>
<html>
<head>
    <title>Personal AI Language Tutor</title>
    <!-- Add Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Overlay to blur the background */
        .card-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5); /* Adjust the alpha value to control the opacity */
          backdrop-filter: blur(5px); /* For modern browsers that support backdrop-filter */
          z-index: 9999;
          display: none;
        }
      
        /* Card content */
        .card-content {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          max-width: 400px;
          background-color: #fff;
          border-radius: 10px;
        }
      </style>
      <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JJ2HKRJL6Z"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-JJ2HKRJL6Z');
    </script>
</head>
<body>
    <!-- Add this inside the <body> tag -->
    <div class="card-overlay" id="infoCard">
        <div class="card card-content">
        <div class="card-body">
            <h5 class="card-title">Important Information</h5>
            <p class="card-text">This is some useful information that you want to display to the user.</p>
            <button type="button" class="close" id="closeCard">
            <span aria-hidden="true">&times;</span>
            </button>
        </div>
        </div>
    </div>
  
  
    <div class="container mt-5">
        <div>
            <h1 class="h-1">Personal AI Tutor</h1>
            <label for="voiceSelect">Select a Voice:</label>
            <select id="voiceSelect"></select>
            <br>
            <br>
            <label for="promptSelect">Select a Topic:</label>
            <select id="promptSelect"></select>
            <br>
            <button class="btn btn-primary" onclick="tryPrompt()" id="promptBtn">Try Prompt</button>
        </div>
        <br>
        <div class="form-group">
            <label for="apiKeyInput">Enter your ChatGPT API Key:</label>
            <input type="text" class="form-control" id="apiKeyInput" placeholder="API Key" value="">
        </div>
        <div class="card">
            <div class="card-body" id="chatContainer">
                <!-- Chat messages will be displayed here -->
                <div class="alert">Welcome to the ESL student helper!</div>
            </div>
        </div>
        <div class="card mt-3">
            <div class="card-body">
                <textarea class="form-control mb-3" id="textInput" rows="2" placeholder="Edit your text"></textarea>
                <button class="btn btn-primary ml-2" onclick="toggleRecording()" id="recorderToggle">Start Recording</button>
                <button class="btn btn-success" onclick="continueConversation()">Ask Tutor</button>
                <div class="alert">Dramatization because I don't have an OpenAI API Key anymore</div>
            </div>
        </div>
    </div>
    <br>

    <!-- Add Bootstrap JS and your custom script -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    
    <!-- Add this inside the <body> tag, after the Bootstrap JavaScript import -->
    <script>
        // Function to show the card on page load

        document.ready(function() {
            document.getElementById("infoCard").fadeIn();
        });

        document.getElementById("closeCard").onclick = function() {
            document.getElementById("infoCard").fadeOut();
        }
    </script>

    <script>
        // Your custom JavaScript code will go here
        // Global variables
        let recognition;
        let isRecording = false;
        const chatContainer = document.getElementById('chatContainer');
        const textInput = document.getElementById('textInput');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const recorderToggle = document.getElementById('recorderToggle');
        const voiceSelect = document.getElementById("voiceSelect");
        const promptSelect = document.getElementById("promptSelect");

        const preprompt = "You are a tutor for students interested in learning English. You must help them learn new vocabulary and help them speak in realistic scenarios. Use simple language and be sure to define complicated words.";
        let conversation = [preprompt, "AI Tutor: Hi! It's nice to meet you!"];

        const prompts = [
            ["Vocabulary", "Make a list of words about "],
            ["Grammar", "What are some common parts of speech?"],
            ["Conversation", "Let's talk about "]
        ];

        const topics = [
            "Family",
            "Weather",
            "Food",
            "Colors",
            "Animals",
            "Clothing",
            "Jobs",
            "Transportation",
            "Daily routines",
            "Hobbies",
            "Sports",
            "Body parts",
            "Numbers",
            "Time",
            "Seasons",
            "Holidays",
            "School",
            "Shopping",
            "Travel",
            "Emotions",
            "Music",
            "Countries and nationalities",
            "Fruits",
            "Vegetables",
            "being in the city",
            "being in the countryside",
            "being at the beach",
            "being at the park",
            "being at the airport",
            "being at the restaurant",
            "being at the doctor's office",
            "being at the supermarket",
            "being at the movie theater",
            "being at the zoo",
            "being at the museum",
            "being at the library",
            "being at the post office",
            "being at the bank",
            "being at the gym",
            "being at the hotel",
            "being at the office",
            "being at the gas station",
            "being at the farm",
            "being at the bakery",
            "being at the hair salon",
            "being at the amusement park",
            "being at the aquarium",
            "being at the train station",
            "being at the bus stop",
            "being at the police station"
        ]

        // Generated Using ChatGPT
        const grammarQuestions = [
            "What is the difference between a noun and a pronoun?",
            "How do you form the plural of regular nouns in English?",
            "Can you explain the concept of subject-verb agreement?",
            "What are the basic tenses in English, and how are they used?",
            "How do you use articles (a, an, the) correctly in English sentences?",
            "What is the difference between 'much' and 'many'?",
            "When do you use 'a' and 'an' before a noun, and when do you use 'the'?",
            "Explain the difference between 'there,' 'their,' and 'they're.'",
            "How do you form the past simple tense of regular verbs?",
            "Describe the difference between 'do' and 'does' in questions and negatives.",
            "What is the difference between 'this,' 'that,' 'these,' and 'those'?",
            "How do you use adjectives to describe nouns in English?",
            "Can you explain the use of prepositions in English sentences?",
            "Describe the difference between 'can' and 'could' for expressing ability.",
            "What is the passive voice, and how is it formed in English?",
            "How do you use modal verbs like 'must,' 'should,' and 'might' in sentences?",
            "Explain the concept of countable and uncountable nouns.",
            "What are relative clauses, and how are they used in English?",
            "Describe the difference between 'good' and 'well.'",
            "How do you form questions in the present simple tense?",
            "Explain the difference between 'your' and 'you're.'",
            "What are irregular verbs, and how are they different from regular verbs?",
            "How do you use 'much' and 'many' in questions and negatives?",
            "What is the difference between 'between' and 'among'?",
            "Describe the use of conjunctions in English sentences."
        ];

        for (let prompt of prompts) {
            let option = document.createElement("option");
            option.text = prompt[0];
            promptSelect.add(option);
        }

        window.onload(
            setup()
        )

        function setup() {
            speak("")
            createChatMessage("AI Tutor: Hi! It's nice to meet you!")
            apiKeyInput.value = (new URL(document.location)).searchParams.get('apiKey');
        }

        function tryPrompt() {
            let prompt = promptSelect.value;

            if (prompt == "Grammar") {
                textInput.value += grammarQuestions[Math.floor(Math.random() * grammarQuestions.length)];
                return;
            }

            let text = prompts.find(x => x[0] == prompt)[1];
            textInput.value += text;
            textInput.value += topics[Math.floor(Math.random() * topics.length)].toLowerCase();

        }

        // Creates String to send to ChatGPT
        function returnFullString() {
            let fullString = "";
            for (let i = 0; i < conversation.length; i++) {
                fullString += conversation[i] + " \n";
            }
            return fullString;
        }

        // Function to create a new chat message element
        function createChatMessage(text, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'alert alert-primary' : 'alert alert-secondary';
            
            const textSpan = document.createElement('span');
            textSpan.textContent = text;

            const speakerIcon = document.createElement('i');
            speakerIcon.className = 'fas fa-volume-up ml-2'; // Assuming you have Font Awesome for the speaker icon

            speakerIcon.addEventListener('click', () => speak(text));

            messageDiv.appendChild(textSpan);
            messageDiv.appendChild(speakerIcon);
            
            chatContainer.appendChild(messageDiv);
            let name = isUser ? 'Student: ' : 'AI Tutor: ';
            conversation.push(isUser +  text);
        }

        function toggleRecording() {
            if (!isRecording) {
                recorderToggle.innerText = "Stop Recording";
                recognition = new webkitSpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;

                recognition.onresult = event => {
                    let text ="";
                    for (let i = 0; i < event.results.length; i++) {
                        text += event.results[i][0].transcript;
                    }
                    textInput.value = text;
                    console.log(text);
                };

                recognition.start();
            } else {
                recognition.stop();
                recorderToggle.innerText = "Start Recording";
            }

            isRecording = !isRecording;
        }

        // Function to call ChatGPT API for text-to-speech
        async function continueConversation() {
            const textToSpeak = textInput.value;
            if (textToSpeak.length === 0) {
                createChatMessage('Please enter something to send!');
                return;
            }
            createChatMessage(`You: ${textToSpeak}`, true);
            isRecording = false;
            textInput.value = "";
            if (recognition != undefined) {
                recognition.stop();
                recorderToggle.innerText = "Start Recording";
            }

            const apiKey = apiKeyInput.value.trim(); // Get the API key from the input
            
            if (apiKey === '') { // changing this line for maker portfolio intro
                text = "AI Tutor: Hello Akash! I'm excited to take a look at your projects. "
                setTimeout(() => {
                    createChatMessage(text) 
                    speak(text)
                }, 1000);
                textInput.value = "";
                return;
            }

            const apiUrl = 'https://api.openai.com/v1/engines/text-davinci-002/completions';

            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            };

            const body = JSON.stringify({
                prompt: returnFullString(),
                max_tokens: 150,
                temperature: 0.7
            });

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: headers, body: body });
                const data = await response.json();
                console.log(response);
                console.log(data);
                const chatGptResponse = removeFalse(data.choices[0].text.trim());

                createChatMessage(`${chatGptResponse}`);
                speak(chatGptResponse); // Call the text-to-speech function
                textInput.value = "";
                textInput.scrollIntoView();
            } catch (error) {
                console.error('Error calling ChatGPT API:', error);
                createChatMessage('AI Tutor: Sorry, something went wrong. ');
            }
        }

        // function to remove the random falses at the beginning of the string
        function removeFalse(string) {
            if (string.substring(0, 5) === "false") {
                return removeFalse(string.substring(5));
            }
            return string;
        }

        function getSubstringBefore(string, substring) {
            // Get the index of the specified string in the original string.
            const index = string.indexOf(substring);

            // If the specified string is not found, return string.
            if (index === -1) {
                return string;
            }

            // Get the substring before the specified string.
            const substringBefore = string.slice(index + substring.length, string.length);

            // Return the substring.
            return substringBefore;
        }

        // Function to convert AI responses to spoken audio
        function speak(text) {
            if ('speechSynthesis' in window) {
                const msg = new SpeechSynthesisUtterance(getSubstringBefore(text, "AI Tutor: "));
                // speeding it up for now
                msg.rate = 1.5;

                // Get available voices
                let voices = [];
                voices = window.speechSynthesis.getVoices();

                function populateVoices() {
                    voices = window.speechSynthesis.getVoices();
                    voiceSelect.innerHTML = "";
                    voices.forEach(voice => {
                        const option = document.createElement('option');
                        option.value = voice.lang;
                        option.textContent = voice.name + ' (' + voice.lang + ')';
                        voiceSelect.appendChild(option);
                    });
                }

                // Chrome fires 'voiceschanged' event when voices are loaded
                if ('onvoiceschanged' in window.speechSynthesis) {
                    window.speechSynthesis.onvoiceschanged = populateVoices;
                }
                
                if (voiceSelect.length <= 0) {
                    populateVoices();
                }

                // Set the desired voice based on the selection
                const selectedVoice = voiceSelect.value;
                msg.voice = voices.find(voice => voice.lang === selectedVoice);

                window.speechSynthesis.speak(msg);
            } else {
                alert('Text-to-speech is not supported in this browser.');
            }
        }
    </script>
</body>
</html>
